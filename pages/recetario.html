<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Recetario de la Ag√ºela - Banco de Memoria de Aledo</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='hotpink'/></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; color: #333; line-height: 1.6; }
    
    /* Header */
    header { background: #25A6F1; color: white; padding: 20px; text-align: center; }
    header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    .back-btn { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    
    /* Layout principal */
    .main-container { display: flex; min-height: calc(100vh - 100px); }
    
    /* Columna izquierda */
    .left-column { flex: 1; padding: 30px; }
    .description { margin-bottom: 30px; }
    .description h2 { color: #25A6F1; margin-bottom: 15px; font-size: 1.8rem; }
    .description p { font-size: 1.1rem; line-height: 1.8; color: #555; }
    
    /* Recetario completo */
    .recetario-completo { margin-bottom: 30px; }
    .recetario-completo h2 { color: #25A6F1; margin-bottom: 15px; font-size: 1.8rem; }
    .recetario-completo iframe { 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .recetario-completo a { 
      color: #25A6F1; 
      text-decoration: none; 
      font-weight: bold;
      transition: color 0.2s ease;
    }
    .recetario-completo a:hover { 
      color: #1e8bc4; 
      text-decoration: underline;
    }
    
    
    /* Columna derecha - Galer√≠a */
    .right-column { flex: 1; padding: 30px; background: white; }
    .gallery h3 { color: #25A6F1; margin-bottom: 20px; font-size: 1.8rem; }
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .gallery-item { background: white; border-radius: 0px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; }
    .gallery-item.highlighted { border: 3px solid hotpink; }
    .gallery-item img { width: 100%; height: 200px; object-fit: cover; }
    .gallery-item .info { padding: 15px; }
    .gallery-item h4 { color: #25A6F1; margin-bottom: 0px; }
    .gallery-item p { display: none; }
    
    /* Panel modal de informaci√≥n */
    #info-panel { 
      position:fixed; 
      top:0; 
      left:0; 
      width:100%; 
      height:100%; 
      background:rgba(0,0,0,0.5); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      z-index:2000; 
      opacity:0; 
      visibility:hidden; 
      transition:opacity 0.4s ease, visibility 0.4s ease; 
    }
    #info-panel.active { 
      opacity:1; 
      visibility:visible; 
    }
    #info-panel .modal-content { 
      background:#fff; 
      width:95%; 
      max-width:900px; 
      max-height:90vh; 
      overflow-y:auto; 
      position:relative; 
      padding:30px; 
      border-radius: 0px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.7) translateY(30px);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    #info-panel .modal-content::-webkit-scrollbar {
      display: none; /* Chrome, Safari and Opera */
    }
    #info-panel.active .modal-content {
      transform: scale(1) translateY(0);
      opacity: 1;
    }
    #info-panel .close-btn { 
      position:absolute; 
      top:15px; 
      right:20px; 
      font-size:24px; 
      cursor:pointer; 
      color:#666; 
      transition: color 0.2s ease;
    }
    #info-panel .close-btn:hover { 
      color:#000; 
    }
    #info-panel h3 { 
      margin-top:0; 
      font-size:24px; 
      margin-bottom:20px; 
      color: #000;
      font-family: 'Neue Haas Grotesk Display Pro 55 Roman', sans-serif !important;
    }
    #info-panel iframe { 
      width:100%; 
      height:200px; 
      border:none; 
      margin-bottom:15px; 
    }
    #info-panel img { 
      width:100%; 
      height:250px; 
      object-fit:cover; 
      margin-bottom:15px; 
    }
    #info-panel p { 
      font-size:16px; 
      margin:8px 0; 
      line-height:1.6; 
    }
    #info-panel a { 
      color:#0066cc; 
      text-decoration:underline; 
      font-size:16px; 
    }
    /* Reservado para estilos futuros del contenido del panel */
    /* #panel-content { } */
    /* Animaciones para el contenido del modal */
    #panel-content.fade-out {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s, transform 0.4s;
    }
    #panel-content.fade-in {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.4s, transform 0.4s;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .main-container { flex-direction: column; }
      .left-column, .right-column { padding: 20px; }
      .recetario-completo iframe { height: 400px; }
    }
    
    @media (max-width: 480px) {
      .recetario-completo iframe { height: 300px; }
    }
  </style>
  <style>
    @font-face {
      font-family: 'Neue Haas Grotesk Display Pro 55 Roman';
      src: url('../assets/fonts/NeueHaasDisplayRoman.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      font-family: 'Neue Haas Grotesk Display Pro 55 Roman', sans-serif !important;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'OCR A Extended', monospace !important;
    }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" onclick="window.location.href='../index.html'">‚Üê Volver</button>
    <h1>Recetario de la Ag√ºela</h1>
  </header>
  
  <div class="main-container">
    <div class="left-column">
      <div class="description">
        <h2>Sabores y memoria de Aledo</h2>
        <p>El Recetario de la Ag√ºela recopila platos, dulces y elaboraciones tradicionales que han pasado de generaci√≥n en generaci√≥n en Aledo. Cada receta es una historia: de familia, de temporada, de fiestas y de cuidados.</p>
        <p>Explora la galer√≠a de recetas. Cada elemento contiene una imagen de portada y al hacer clic podr√°s ver el documento completo con la receta detallada.</p>
      </div>
      
      <div class="recetario-completo">
        <h2>Recetario Completo</h2>
        <iframe width="620px" height="597px" src="https://www.yumpu.com/es/embed/view/WoI1A0L4BwusM37U" frameborder="0" allowfullscreen="true"  allowtransparency="true"></iframe><br><a href="https://www.yumpu.com/es/document/view/70850847/recetario" title="Recetario" target="_blank">Recetario</a>
      </div>
      
    </div>
    
    <div class="right-column">
      <div class="gallery">
        <h3>Galer√≠a del Recetario</h3>
        <div class="gallery-grid">
          <!-- La galer√≠a se genera din√°micamente desde el CSV -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables para el panel modal
    var panel, panelContent;

    // Esperar a que el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      panel = document.getElementById('info-panel');
      panelContent = document.getElementById('panel-content');
    });
    
    // Funci√≥n para cargar carpetas desde el archivo JSON (prioriza la carpeta data/recetario en producci√≥n)
    function loadFoldersFromJSON() {
      // Intentar primero la versi√≥n en data/recetario (ubicaci√≥n donde suele desplegarse en GitHub Pages)
      var candidates = ['../data/recetario/carpetas.json', '../recetario/carpetas.json', 'data/recetario/carpetas.json', 'recetario/carpetas.json'];

      // Intentaremos secuencialmente until one works
      function tryUrl(i) {
        if (i >= candidates.length) {
          console.log('Ning√∫n JSON accesible, usando detecci√≥n autom√°tica');
          return Promise.resolve(detectRecetarioFolders());
        }

        var url = candidates[i];
        return fetch(url).then(function(response) {
          if (!response.ok) {
            throw new Error('No se pudo cargar: ' + url);
          }
          return response.json();
        }).then(function(data) {
          console.log('Carpetas cargadas desde JSON (' + url + '):', data.carpetas);
          return data.carpetas || [];
        }).catch(function(err) {
          console.warn('Fallo al cargar', candidates[i], err);
          return tryUrl(i+1);
        });
      }

      return tryUrl(0);
    }
    
    // Funci√≥n para detectar autom√°ticamente las carpetas del recetario
    function detectRecetarioFolders() {
      return new Promise(function(resolve) {
        var folders = [];
        var maxAttempts = 20; // M√°ximo n√∫mero de carpetas a intentar
        var attempts = 0;
        var consecutiveFailures = 0;
        var maxConsecutiveFailures = 3; // Si fallan 3 consecutivas, parar
        
        // Lista de posibles nombres de carpetas a probar
        var possibleNames = [];
        
        // Generar nombres de prueba (prueba1, prueba2, etc.)
        for (var i = 1; i <= maxAttempts; i++) {
          possibleNames.push('prueba' + i);
        }
        
        // A√±adir nombres comunes que podr√≠an existir
        var commonNames = ['holaaa', 'recetas', 'platos', 'dulces', 'tradicionales'];
        possibleNames = possibleNames.concat(commonNames);
        
        function tryNextFolder() {
          if (attempts >= possibleNames.length || consecutiveFailures >= maxConsecutiveFailures) {
            console.log('Detecci√≥n autom√°tica completada. Carpetas encontradas:', folders);
            resolve(folders);
            return;
          }
          
          var folderName = possibleNames[attempts];
          attempts++;
          
          var testImage = new Image();
          
          testImage.onload = function() {
            // Si la imagen se carga, la carpeta existe
            folders.push(folderName);
            consecutiveFailures = 0; // Resetear contador de fallos
            console.log('Carpeta detectada autom√°ticamente:', folderName);
            tryNextFolder();
          };
          
          testImage.onerror = function() {
            // Si la imagen no se carga, incrementar contador de fallos
            consecutiveFailures++;
            console.log('Carpeta no encontrada:', folderName, '(fallos consecutivos:', consecutiveFailures, ')');
            tryNextFolder();
          };
          
          // Intentar cargar la imagen de la carpeta (usamos encodeURIComponent para espacios y caracteres especiales)
          testImage.src = '../recetario/' + encodeURIComponent(folderName) + '/cr7.jpg';
        }
        
        tryNextFolder();
      });
    }
    
    // Funci√≥n para cargar carpetas del recetario din√°micamente
    function loadRecetarioFolders() {
      var galleryGrid = document.querySelector('.gallery-grid');
      galleryGrid.innerHTML = '<div style="text-align:center;padding:20px;">Cargando recetas...</div>';
      
      // Cargar carpetas desde JSON o detectar autom√°ticamente
      loadFoldersFromJSON().then(function(folders) {
        galleryGrid.innerHTML = ''; // Limpiar mensaje de carga
        
        if (folders.length === 0) {
          galleryGrid.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">No se encontraron recetas</div>';
          return;
        }
        
        console.log('Carpetas detectadas:', folders);
        
        folders.forEach(function(folderName) {
          // Crear elemento de galer√≠a din√°micamente
          var galleryItem = document.createElement('div');
          galleryItem.className = 'gallery-item recetario';
          galleryItem.setAttribute('data-name', folderName);
          
          // Intentar leer index.json dentro de la carpeta para obtener nombres reales
          (function(folderName, galleryItem) {
            var encoded = encodeURIComponent(folderName);
            var indexCandidates = ['../data/recetario/' + encoded + '/index.json', '../recetario/' + encoded + '/index.json', 'data/recetario/' + encoded + '/index.json', 'recetario/' + encoded + '/index.json'];

            function useFallback() {
              var coverImage = findCoverImage(folderName);
              galleryItem.innerHTML = `
                <img src="${coverImage}" alt="${folderName}" onerror="this.style.display='none'">
                <div class="info">
                  <h4>${folderName}</h4>
                </div>
              `;
            }

            // Try candidates sequentially
            (function tryIndex(i) {
              if (i >= indexCandidates.length) {
                useFallback();
                return;
              }
              fetch(indexCandidates[i]).then(function(res) {
                if (!res.ok) throw new Error('No index');
                return res.json();
              }).then(function(index) {
                // index.cover and index.pdf are filenames relative to the folder
                var base = indexCandidates[i].replace(/index.json$/, '');
                var coverUrl = index.cover ? (base + encodeURIComponent(index.cover)) : findCoverImage(folderName);
                galleryItem.innerHTML = `
                  <img src="${coverUrl}" alt="${folderName}" onerror="this.style.display='none'">
                  <div class="info">
                    <h4>${folderName}</h4>
                  </div>
                `;
                // Store the resolved base and pdf path for the click handler
                galleryItem.dataset._base = base;
                galleryItem.dataset._pdf = index.pdf ? (base + encodeURIComponent(index.pdf)) : '';
              }).catch(function() {
                tryIndex(i+1);
              });
            })(0);
          })(folderName, galleryItem);
          
          // A√±adir evento click para mostrar PDF (usar pdf resuelto por index.json si existe)
          galleryItem.addEventListener('click', function() {
            // Si el script resolvi√≥ la ruta PDF, √∫sala
            var base = this.dataset._base || null;
            var pdf = this.dataset._pdf || null;
            if (pdf) {
              showPDFViewerWithPath(folderName, pdf);
            } else {
              showPDFViewer(folderName);
            }
          });
          
          galleryGrid.appendChild(galleryItem);
        });
      }).catch(function(error) {
        console.error('Error al detectar carpetas:', error);
        galleryGrid.innerHTML = '<div style="text-align:center;padding:20px;color:#ff0000;">Error al cargar las recetas</div>';
      });
    }
    
    // Funci√≥n para encontrar la imagen de portada en una carpeta.
    // Intenta varias convenciones de nombre y verifica su existencia para evitar 404.
    function findCoverImage(folderName) {
      var possibleImages = ['cr7.jpg', 'cover.jpg', 'portada.jpg', 'imagen.jpg', 'foto.jpg', '450_1000.jpg', 'jallullo.jpg', 'aceitunas-partidas.jpg'];

      var encodedName = encodeURIComponent(folderName);

      // Buscar primero en data/recetario (despliegue en GitHub Pages) y despu√©s en ../recetario
      var baseCandidates = ['../data/recetario/', '../recetario/', 'data/recetario/', 'recetario/'];

      // Devuelve la primera URL que responde ok
      for (var b = 0; b < baseCandidates.length; b++) {
        for (var i = 0; i < possibleImages.length; i++) {
          var url = baseCandidates[b] + encodedName + '/' + possibleImages[i];
          // Nota: no hacemos fetch bloqueante aqu√≠ porque esto se usa al generar la galer√≠a; en navegadores antiguos
          // podr√≠a llegarse a devolver im√°genes inexistentes, pero el onerror ocultar√° la imagen.
          return url;
        }
      }

      // Fallback gen√©rico
      return '../recetario/' + encodedName + '/cr7.jpg';
    }
    
    // Funci√≥n para encontrar el PDF en una carpeta (intenta nombres comunes y varias ubicaciones)
    function findPDF(folderName) {
      var possiblePDFs = ['alfajores.pdf','albondigas.pdf','caldobailao.pdf','cordiales.pdf','empedrao.pdf','cerraja.pdf','ensaladapepino.pdf','gornazo.pdf','jallullo.pdf','mantellina.pdf','migas.pdf','olivaspartias.pdf','pipirriana.pdf','rollosanis.pdf','rollossanblas.pdf','torta.pdf','tortasfritas.pdf','zarangollo.pdf','PRUEBA.pdf','receta.pdf','documento.pdf','archivo.pdf'];
      var encodedName = encodeURIComponent(folderName);
      var baseCandidates = ['../data/recetario/', '../recetario/', 'data/recetario/', 'recetario/'];

      for (var b = 0; b < baseCandidates.length; b++) {
        for (var i = 0; i < possiblePDFs.length; i++) {
          var url = baseCandidates[b] + encodedName + '/' + possiblePDFs[i];
          return url;
        }
      }

      return '../recetario/' + encodedName + '/PRUEBA.pdf';
    }
    
    
    // Cargar carpetas al iniciar
    loadRecetarioFolders();
    
    // Funci√≥n para resaltar elemento en galer√≠a
    function highlightGalleryItem(name) {
      removeHighlight();
      var galleryItem = document.querySelector('.gallery-item[data-name="' + name + '"]');
      if(galleryItem) {
        galleryItem.classList.add('highlighted');
      }
    }
    
    // Funci√≥n para quitar resaltado
    function removeHighlight() {
      document.querySelectorAll('.gallery-item.highlighted').forEach(function(item) {
        item.classList.remove('highlighted');
      });
    }
    
    // Funci√≥n para mostrar el visor de PDF
    function showPDFViewer(folderName) {
      if (!panel || !panelContent) {
        panel = document.getElementById('info-panel');
        panelContent = document.getElementById('panel-content');
      }
      
      if (!panel || !panelContent) {
        return;
      }
      
      panelContent.innerHTML = '';
      
      var html = '<h3>' + folderName + '</h3>';
      
      // Buscar el PDF en la carpeta
      var pdfPath = findPDF(folderName);
      
      html += '<iframe src="' + pdfPath + '" style="width:100%;height:70vh;border:none;margin-bottom:15px;" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\'"></iframe>';
      html += '<div style="display:none; padding:20px; background:#f0f0f0; text-align:center; border-radius:8px; margin-bottom:15px;">';
      html += '<p>‚ö†Ô∏è PDF no disponible</p>';
      html += '<a href="' + pdfPath + '" target="_blank" style="background:#25A6F1; color:white; padding:10px 20px; text-decoration:none; border-radius:5px;">üìÑ Abrir PDF</a>';
      html += '</div>';
      
      panelContent.innerHTML = html;
      panel.classList.add('active');
    }

    // Versi√≥n que recibe ruta ya resuelta
    function showPDFViewerWithPath(folderName, pdfPath) {
      if (!panel || !panelContent) {
        panel = document.getElementById('info-panel');
        panelContent = document.getElementById('panel-content');
      }
      if (!panel || !panelContent) return;

      panelContent.innerHTML = '';
      var html = '<h3>' + folderName + '</h3>';
      html += '<iframe src="' + pdfPath + '" style="width:100%;height:70vh;border:none;margin-bottom:15px;" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\'"></iframe>';
      html += '<div style="display:none; padding:20px; background:#f0f0f0; text-align:center; border-radius:8px; margin-bottom:15px;">';
      html += '<p>‚ö†Ô∏è PDF no disponible</p>';
      html += '<a href="' + pdfPath + '" target="_blank" style="background:#25A6F1; color:white; padding:10px 20px; text-decoration:none; border-radius:5px;">üìÑ Abrir PDF</a>';
      html += '</div>';
      panelContent.innerHTML = html;
      panel.classList.add('active');
    }
    
    // Funci√≥n para mostrar informaci√≥n del elemento en el modal
    function showItemInfo(d) {
      if (!panel || !panelContent) {
        panel = document.getElementById('info-panel');
        panelContent = document.getElementById('panel-content');
      }
      
      if (!panel || !panelContent) {
        return;
      }
      
      panelContent.innerHTML = '';
      
      var html = '<h3>' + d.name + '</h3>';
      
      // Mostrar video si existe, si no imagen
      if(d.embed) {
        html += '<iframe src="'+d.embed+'" allowfullscreen onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\'"></iframe>';
        html += '<div style="display:none; padding:20px; background:#f0f0f0; text-align:center; border-radius:8px; margin-bottom:15px;">';
        html += '<p>‚ö†Ô∏è Video no disponible (bloqueador de anuncios detectado)</p>';
        html += '<a href="'+d.embed+'" target="_blank" style="background:#ff0000; color:white; padding:10px 20px; text-decoration:none; border-radius:5px;">‚ñ∂Ô∏è Ver en YouTube</a>';
        html += '</div>';
      } else if(d.photo && d.photo.trim() !== '') {
        html += '<img src="'+d.photo+'" style="width:100%;height:250px;object-fit:cover;margin-bottom:15px;" onerror="this.style.display=\'none\'">';
      }
      
      if(d.desc) html += '<p><strong>Descripci√≥n:</strong> ' + d.desc + '</p>';
      if(d.chronology) html += '<p><strong>Cronolog√≠a:</strong> ' + d.chronology + '</p>';
      if(d.link) html += '<p><strong>Enlace:</strong> <a href="'+d.link+'" target="_blank">' + d.link + '</a></p>';
      if(d.organizer) html += '<p><strong>Organizador:</strong> ' + d.organizer + '</p>';
      
      panelContent.innerHTML = html;
      panel.classList.add('active');
    }
    
    // Funci√≥n para cerrar el panel
    function closePanel() {
      if (!panel) {
        panel = document.getElementById('info-panel');
      }
      if (panel) {
        panel.classList.remove('active');
      }
    }
  </script>
  
  <style>
    .gallery {
      background: #fff !important;
    }
    .gallery-item {
      border-radius: 0 !important;
      box-shadow: none !important;
      border: 3px solid transparent;
      transition: border-color 0.2s;
    }
    .gallery-item.memoria-oral:hover, .gallery-item.memoria-oral.highlighted { border-color: green !important; }
    .gallery-item.patrimonio-material:hover, .gallery-item.patrimonio-material.highlighted { border-color: hotpink !important; }
    .gallery-item.patrimonio-inmaterial:hover, .gallery-item.patrimonio-inmaterial.highlighted { border-color: #FFD600 !important; }
    .gallery-item.iniciativas-culturales:hover, .gallery-item.iniciativas-culturales.highlighted { border-color: #25A6F1 !important; }
    .gallery-item.recetario:hover, .gallery-item.recetario.highlighted { border-color: orange !important; }
  </style>
  
  <!-- Panel modal de informaci√≥n -->
  <div id="info-panel" onclick="closePanel()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="close-btn" onclick="closePanel()">√ó</div>
      <div id="panel-content"></div>
    </div>
  </div>
</body>
</html>